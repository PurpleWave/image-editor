/*!
 * ImageEditor v1.0.0
 * https://github.com/PurpleWave/image-editor#readme
 *
 * Copyright 2019-present Alex Neises
 * Released under the MIT license
 *
 * Date: 2019-05-01T14:56:50.075Z
 */'use strict';class BlurStack{constructor(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}}const mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];class ImageEditor{constructor(a,b){this.ogPath=a,this.canvas=b,this.img=new Image,this.undoStack=[],this.redoStack=[],this.rect={},this.img.onload=()=>{const a=this.img.width/this.img.height;this.newWidth=this.canvas.width,this.newHeight=this.newWidth/a,this.newHeight>this.canvas.height&&(this.newHeight=this.canvas.height,this.newWidth=this.newHeight*a),this.canvas.width=this.newWidth,this.canvas.height=this.newHeight,this.ctx=this.canvas.getContext("2d"),this.ctx.drawImage(this.img,0,0,this.newWidth,this.newHeight),this.ctx.save()},this.addToUndo(a),this.img.src=a}getWidth(){return this.newWidth}getHeight(){return this.newHeight}addToUndo(a){this.undoStack.push(a)}addToRedo(a){this.redoStack.push(a)}setBoundingOrigin(a,b){this.rect.startX=a,this.rect.startY=b}drawBoundingBox(a,b){this.rect.w=a,this.rect.h=b,this.ctx.drawImage(this.img,0,0,this.newWidth,this.newHeight),this.ctx.save(),this.draw(),this.ctx.restore()}draw(){this.ctx.setLineDash([6]),this.ctx.strokeStyle="rgba(0, 0, 0, 0.75)",this.ctx.lineWidth=4,this.ctx.strokeRect(this.rect.startX,this.rect.startY,this.rect.w,this.rect.h),this.ctx.strokeStyle="rgba(255, 255, 255, 1)",this.ctx.lineWidth=2,this.ctx.strokeRect(this.rect.startX,this.rect.startY,this.rect.w,this.rect.h)}setBrightness(a){this.ctx.drawImage(this.img,0,0,this.newWidth,this.newHeight),this.ctx.save(),0>a?(this.ctx.globalCompositeOperation="multiply",this.ctx.fillStyle="black",this.ctx.globalAlpha=-a/100,this.ctx.fillRect(0,0,this.newWidth,this.newHeight)):0<a&&(this.ctx.fillStyle="white",this.ctx.globalCompositeOperation="lighten",this.ctx.globalAlpha=1,this.ctx.globalAlpha=a/100,this.ctx.fillRect(0,0,this.newWidth,this.newHeight)),this.ctx.restore()}apply(){this.addToUndo(this.canvas.toDataURL()),this.img.src=this.canvas.toDataURL()}reset(){this.undoStack=[],this.redoStack=[],this.addToUndo(this.ogPath),this.img.src=this.ogPath}undo(){1<this.undoStack.length&&(this.img.src=this.undoStack[this.undoStack.length-2],this.redoStack.unshift(this.undoStack.pop()))}redo(){1<=this.redoStack.length&&(this.img.src=this.redoStack[0],this.undoStack.push(this.redoStack.shift()))}setBlur(a,b={},c={}){var d=Math.abs;const e={x:b.x?b.x:0,y:b.y?b.y:0},f={x:c.x?c.x:this.newWidth,y:c.y?c.y:this.newHeight},g=d(f.x-e.x),i=d(f.y-e.y);this.ctx.clearRect(0,0,g,i),this.ctx.drawImage(this.img,0,0,this.newWidth,this.newHeight),1<=a?this._stackBlurCanvasRGBA(a,e,g,i):this.img.src=this.img.src}_stackBlurCanvasRGBA(a,b,c,d){if(isNaN(a||1>a))return;a|=0;const e=this.ctx.getImageData(b.x,b.y,c,d),f=e.data;let g,h,j,k,l,m,n,o,q,r,s,t,u,v,w,z,A,B,C,D,E,F,G,H;const I=a+a+1,J=c-1,K=d-1,L=a+1,M=L*(L+1)/2,N=new BlurStack;let O,P=N;for(j=1;j<I;j++)P=P.next=new BlurStack,j==L&&(O=P);P.next=N;let Q=null,R=null;n=m=0;const S=mul_table[a],T=shg_table[a];for(h=0;h<d;h++){for(z=A=B=C=o=q=r=s=0,t=L*(D=f[m]),u=L*(E=f[m+1]),v=L*(F=f[m+2]),w=L*(G=f[m+3]),o+=M*D,q+=M*E,r+=M*F,s+=M*G,P=N,j=0;j<L;j++)P.r=D,P.g=E,P.b=F,P.a=G,P=P.next;for(j=1;j<L;j++)k=m+((J<j?J:j)<<2),o+=(P.r=D=f[k])*(H=L-j),q+=(P.g=E=f[k+1])*H,r+=(P.b=F=f[k+2])*H,s+=(P.a=G=f[k+3])*H,z+=D,A+=E,B+=F,C+=G,P=P.next;for(Q=N,R=O,g=0;g<c;g++)f[m+3]=G=s*S>>T,0==G?f[m]=f[m+1]=f[m+2]=0:(G=255/G,f[m]=(o*S>>T)*G,f[m+1]=(q*S>>T)*G,f[m+2]=(r*S>>T)*G),o-=t,q-=u,r-=v,s-=w,t-=Q.r,u-=Q.g,v-=Q.b,w-=Q.a,k=n+((k=g+a+1)<J?k:J)<<2,z+=Q.r=f[k],A+=Q.g=f[k+1],B+=Q.b=f[k+2],C+=Q.a=f[k+3],o+=z,q+=A,r+=B,s+=C,Q=Q.next,t+=D=R.r,u+=E=R.g,v+=F=R.b,w+=G=R.a,z-=D,A-=E,B-=F,C-=G,R=R.next,m+=4;n+=c}for(g=0;g<c;g++){for(A=B=C=z=q=r=s=o=0,m=g<<2,t=L*(D=f[m]),u=L*(E=f[m+1]),v=L*(F=f[m+2]),w=L*(G=f[m+3]),o+=M*D,q+=M*E,r+=M*F,s+=M*G,P=N,j=0;j<L;j++)P.r=D,P.g=E,P.b=F,P.a=G,P=P.next;for(l=c,j=1;j<=a;j++)m=l+g<<2,o+=(P.r=D=f[m])*(H=L-j),q+=(P.g=E=f[m+1])*H,r+=(P.b=F=f[m+2])*H,s+=(P.a=G=f[m+3])*H,z+=D,A+=E,B+=F,C+=G,P=P.next,j<K&&(l+=c);for(m=g,Q=N,R=O,h=0;h<d;h++)k=m<<2,f[k+3]=G=s*S>>T,0<G?(G=255/G,f[k]=(o*S>>T)*G,f[k+1]=(q*S>>T)*G,f[k+2]=(r*S>>T)*G):f[k]=f[k+1]=f[k+2]=0,o-=t,q-=u,r-=v,s-=w,t-=Q.r,u-=Q.g,v-=Q.b,w-=Q.a,k=g+((k=h+L)<K?k:K)*c<<2,o+=z+=Q.r=f[k],q+=A+=Q.g=f[k+1],r+=B+=Q.b=f[k+2],s+=C+=Q.a=f[k+3],Q=Q.next,t+=D=R.r,u+=E=R.g,v+=F=R.b,w+=G=R.a,z-=D,A-=E,B-=F,C-=G,R=R.next,m+=c}this.ctx.putImageData(e,b.x,b.y)}}module.exports=ImageEditor;
